import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { PRICING } from '../config';
import apiService from '../services/api';
import authService from '../services/auth';
import analytics from '../utils/analytics';

export default function Pricing() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [subscription, setSubscription] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [openFaq, setOpenFaq] = useState(null);

  useEffect(() => {
    checkAuth();
    analytics.trackPricingPageViewed();
  }, []);

  const checkAuth = async () => {
    const authenticated = await authService.isAuthenticated();
    setIsAuthenticated(authenticated);

    if (authenticated) {
      try {
        const sub = await apiService.getSubscription();
        setSubscription(sub);
      } catch (err) {
        console.error('Failed to fetch subscription:', err);
      }
    }
  };

  const handleUpgrade = async () => {
    if (!isAuthenticated) {
      // Redirect to login, then back to pricing
      navigate('/');
      return;
    }

    // Track upgrade button click
    analytics.trackUpgradeClicked('pricing_page');
    analytics.trackCheckoutStarted();

    setLoading(true);
    setError('');

    try {
      console.log('[CHECKOUT] ===== STARTING CHECKOUT PROCESS =====');
      const successUrl = `${window.location.origin}/success`;
      const cancelUrl = `${window.location.origin}/pricing`;
      console.log('[CHECKOUT] Success URL:', successUrl);
      console.log('[CHECKOUT] Cancel URL:', cancelUrl);

      console.log('[CHECKOUT] Calling apiService.createCheckoutSession...');
      const response = await apiService.createCheckoutSession(successUrl, cancelUrl);
      console.log('[CHECKOUT] API response received:', response);
      console.log('[CHECKOUT] Response type:', typeof response);
      console.log('[CHECKOUT] Response keys:', response ? Object.keys(response) : 'null');

      if (!response) {
        console.error('[CHECKOUT] ERROR: Response is null or undefined');
        throw new Error('No response from server. Please check your connection and try again.');
      }

      if (!response.url) {
        console.error('[CHECKOUT] ERROR: Response missing URL field');
        console.error('[CHECKOUT] Full response:', JSON.stringify(response, null, 2));
        throw new Error(`Invalid response from server: missing checkout URL. Got: ${JSON.stringify(response)}`);
      }

      const checkoutUrl = response.url;
      console.log('[CHECKOUT] Checkout URL:', checkoutUrl);
      console.log('[CHECKOUT] Redirecting to Stripe Checkout...');

      // Redirect to Stripe Checkout
      window.location.href = checkoutUrl;
    } catch (err) {
      console.error('[CHECKOUT] ===== CHECKOUT FAILED =====');
      console.error('[CHECKOUT] Error type:', err.constructor?.name);
      console.error('[CHECKOUT] Error message:', err.message);
      console.error('[CHECKOUT] Error stack:', err.stack);
      console.error('[CHECKOUT] Full error:', err);
      console.error('[CHECKOUT] ===== END ERROR =====');

      // Show detailed error to user
      const errorMessage = err.message || 'Failed to start checkout. Please try again.';
      setError(`Checkout Error: ${errorMessage}`);
      setLoading(false);
    }
  };

  const isPro = subscription?.subscription_status === 'pro';

  const toggleFaq = (index) => {
    setOpenFaq(openFaq === index ? null : index);
  };

  // Enhanced features for Free tier
  const freeFeatures = [
    '5 invoices per month',
    'AI-powered generation (30 seconds per invoice)',
    'Professional INVOICE header',
    'Add your contact information',
    'PDF download',
    'Email support'
  ];

  // Enhanced features for Pro tier
  const proFeatures = [
    'UNLIMITED invoices',
    'Custom business name on invoices',
    '5 professional color themes',
    'No "Generated by ScatterPilot" watermark',
    'Priority email support (24hr response)',
    'Everything in Free, plus:',
    '  ‚Ä¢ Custom branding',
    '  ‚Ä¢ Professional appearance',
    '  ‚Ä¢ Faster support'
  ];

  // FAQ data with new questions
  const faqs = [
    {
      question: 'What happens if I exceed my free tier limit?',
      answer: 'You\'ll need to wait until the next month or upgrade to Pro for unlimited invoices. Your limit resets on the 1st of each month.'
    },
    {
      question: 'Do I need a credit card to try Pro?',
      answer: 'No! Start with 5 free invoices on our Free plan. Upgrade to Pro anytime - only $18/month with no contract.'
    },
    {
      question: 'Can I cancel anytime?',
      answer: 'Yes, cancel anytime with one click. No questions asked, no hidden fees. You\'ll keep Pro access until the end of your billing period.'
    },
    {
      question: 'What payment methods do you accept?',
      answer: 'We accept all major credit cards including Visa, Mastercard, and American Express. Payments are securely processed by Stripe.'
    }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-purple-100 py-12 px-4 sm:px-6 lg:px-8 relative overflow-hidden">
      {/* Decorative blur elements */}
      <div className="absolute top-0 left-1/4 w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" />
      <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{ animationDelay: '2s' }} />

      <div className="max-w-6xl mx-auto relative z-10">
        {/* Hero Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="text-center mb-16"
        >
          <h1 className="text-5xl md:text-6xl font-bold text-gray-900 mb-6 bg-clip-text text-transparent bg-gradient-brand">
            Simple, Transparent Pricing
          </h1>
          <p className="text-2xl text-gray-700">
            Choose the plan that works for your business
          </p>
        </motion.div>

        {error && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            className="mb-8 p-4 bg-red-50 border-2 border-red-200 rounded-xl text-red-700 text-center shadow-lg"
          >
            {error}
          </motion.div>
        )}

        {/* Pricing Cards */}
        <div className="grid md:grid-cols-2 gap-8 mb-16">
          {/* Free Plan */}
          <motion.div
            initial={{ opacity: 0, y: 30 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6, delay: 0.1 }}
            whileHover={{ scale: 1.02, y: -5 }}
            className="bg-white rounded-2xl shadow-2xl p-10 border-2 border-gray-200 hover:shadow-glow-purple transition-all duration-300"
          >
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-2">Free</h2>
              <div className="mt-6">
                <span className="text-6xl font-bold text-gray-900">$0</span>
                <span className="text-xl text-gray-600">/month</span>
              </div>
              <p className="mt-4 text-sm text-gray-600">Perfect for getting started</p>
            </div>

            <ul className="space-y-4 mb-10">
              {freeFeatures.map((feature, index) => (
                <motion.li
                  key={index}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.2 + index * 0.05 }}
                  className="flex items-start"
                >
                  <svg className="w-6 h-6 text-purple-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 13l4 4L19 7" />
                  </svg>
                  <span className="text-gray-700 text-base">{feature}</span>
                </motion.li>
              ))}
            </ul>

            <button
              disabled={true}
              className="w-full py-4 px-6 rounded-xl font-semibold text-lg bg-gray-100 text-gray-500 cursor-not-allowed border-2 border-gray-200"
            >
              {isPro ? 'Previous Plan' : 'Current Plan'}
            </button>
          </motion.div>

          {/* Pro Plan */}
          <motion.div
            initial={{ opacity: 0, y: 30 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6, delay: 0.2 }}
            whileHover={{ scale: 1.02, y: -5 }}
            className="bg-white rounded-2xl shadow-2xl p-10 border-4 border-blue-500 relative hover:shadow-glow-purple-lg transition-all duration-300"
          >
            <motion.div
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              transition={{ delay: 0.5, type: "spring", stiffness: 200 }}
              className="absolute -top-5 left-1/2 transform -translate-x-1/2"
            >
              <span className="bg-gradient-brand text-white px-6 py-2 rounded-full text-base font-bold shadow-lg animate-pulse">
                ‚≠ê POPULAR
              </span>
            </motion.div>

            <div className="text-center mb-8 mt-2">
              <h2 className="text-3xl font-bold text-gray-900 mb-2">Pro</h2>
              <div className="mt-6">
                <span className="text-6xl font-bold bg-clip-text text-transparent bg-gradient-brand">${PRICING.pro.price}</span>
                <span className="text-xl text-gray-600">/month</span>
              </div>
              <p className="mt-4 text-sm text-gray-600 font-semibold">Most popular for consultants billing 6+ clients</p>
            </div>

            <ul className="space-y-4 mb-10">
              {proFeatures.map((feature, index) => (
                <motion.li
                  key={index}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.3 + index * 0.05 }}
                  className="flex items-start"
                >
                  <svg className="w-6 h-6 text-purple-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 13l4 4L19 7" />
                  </svg>
                  <span className={`text-gray-700 text-base ${feature.startsWith('UNLIMITED') ? 'font-bold' : ''}`}>{feature}</span>
                </motion.li>
              ))}
            </ul>

            {isPro ? (
              <button
                disabled={true}
                className="w-full py-4 px-6 rounded-xl font-semibold text-lg bg-green-100 text-green-700 cursor-not-allowed border-2 border-green-200"
              >
                ‚úì Current Plan
              </button>
            ) : (
              <motion.button
                onClick={handleUpgrade}
                disabled={loading}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.98 }}
                className="w-full py-4 px-6 rounded-xl font-bold text-lg text-white bg-gradient-brand hover:bg-gradient-brand-hover transition-all shadow-lg hover:shadow-glow-purple disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {loading ? (
                  <span className="flex items-center justify-center">
                    <svg className="animate-spin -ml-1 mr-3 h-6 w-6 text-gray-900" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                    </svg>
                    Processing...
                  </span>
                ) : (
                  'Upgrade to Pro ‚Üí'
                )}
              </motion.button>
            )}

            {!isPro && (
              <p className="mt-4 text-center text-sm text-gray-600">
                Start free today. Upgrade when you need unlimited invoices - takes 60 seconds.
              </p>
            )}
          </motion.div>
        </div>

        {/* Usage Info */}
        {subscription && !isPro && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.4 }}
            className="mb-16 p-6 bg-white rounded-xl shadow-lg text-center border-2 border-gray-200"
          >
            <p className="text-gray-700 text-lg">
              You've used <span className="font-bold text-purple-600">{subscription.invoices_this_month}</span> of{' '}
              <span className="font-bold text-purple-600">{subscription.invoices_limit}</span> invoices this month.
              {subscription.invoices_remaining <= 2 && (
                <span className="text-orange-600 ml-2 font-semibold">
                  Upgrade to Pro for unlimited invoices!
                </span>
              )}
            </p>
          </motion.div>
        )}

        {/* Value Proposition Comparison */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.5 }}
          className="mb-16 bg-white rounded-2xl shadow-xl p-10 border-2 border-purple-200"
        >
          <h3 className="text-3xl font-bold text-center mb-10 text-gray-900">
            Why ScatterPilot?
          </h3>
          <div className="grid md:grid-cols-2 gap-8">
            {/* Traditional */}
            <div className="space-y-4">
              <h4 className="text-xl font-bold text-gray-700 mb-4">Traditional invoicing:</h4>
              {[
                '20-30 minutes per invoice',
                'Manual calculations',
                'Formatting headaches',
                'Lost time = lost money'
              ].map((item, index) => (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: -20 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.6 + index * 0.1 }}
                  className="flex items-center text-gray-600"
                >
                  <span className="text-2xl mr-3">‚ùå</span>
                  <span className="text-lg">{item}</span>
                </motion.div>
              ))}
            </div>

            {/* ScatterPilot */}
            <div className="space-y-4">
              <h4 className="text-xl font-bold text-purple-600 mb-4">ScatterPilot:</h4>
              {[
                '30 seconds per invoice',
                'Automatic calculations',
                'Professional formatting',
                'Save 100+ hours/year'
              ].map((item, index) => (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: 20 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.6 + index * 0.1 }}
                  className="flex items-center text-gray-700 font-medium"
                >
                  <span className="text-2xl mr-3">‚úÖ</span>
                  <span className="text-lg">{item}</span>
                </motion.div>
              ))}
            </div>
          </div>
        </motion.div>

        {/* Trust Signals */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.6 }}
          className="mb-16 grid grid-cols-2 md:grid-cols-4 gap-6"
        >
          {[
            { icon: 'üîí', text: 'Secure payments via Stripe' },
            { icon: 'üìß', text: 'Email support for all users' },
            { icon: 'üí≥', text: 'Cancel anytime, no contract' },
            { icon: '‚ö°', text: 'Instant activation' }
          ].map((item, index) => (
            <motion.div
              key={index}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: 0.7 + index * 0.1 }}
              className="bg-white p-6 rounded-xl shadow-md text-center hover:shadow-lg transition-shadow"
            >
              <div className="text-4xl mb-3">{item.icon}</div>
              <p className="text-sm text-gray-700 font-medium">{item.text}</p>
            </motion.div>
          ))}
        </motion.div>

        {/* Social Proof */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.7 }}
          className="mb-16 bg-gradient-brand rounded-2xl p-10 text-center text-white shadow-2xl"
        >
          <h3 className="text-3xl font-bold mb-8">
            Trusted by Freelancers & Consultants
          </h3>
          <div className="grid md:grid-cols-3 gap-8">
            <div>
              <div className="text-5xl font-bold mb-2">2,800+</div>
              <p className="text-purple-100">Invoices created</p>
            </div>
            <div>
              <div className="text-5xl font-bold mb-2">500+</div>
              <p className="text-purple-100">Hours saved</p>
            </div>
            <div>
              <div className="text-5xl font-bold mb-2">4.8/5</div>
              <p className="text-purple-100">Average rating</p>
            </div>
          </div>
        </motion.div>

        {/* FAQ Section */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.8 }}
          className="mb-16"
        >
          <h3 className="text-4xl font-bold text-gray-900 text-center mb-10">
            Frequently Asked Questions
          </h3>
          <div className="space-y-4">
            {faqs.map((faq, index) => (
              <motion.div
                key={index}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.9 + index * 0.1 }}
                className="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-200 hover:border-purple-300 transition-colors"
              >
                <button
                  onClick={() => toggleFaq(index)}
                  className="w-full p-6 text-left flex items-center justify-between hover:bg-purple-50 transition-colors"
                >
                  <h4 className="font-bold text-gray-900 text-lg pr-4">
                    {faq.question}
                  </h4>
                  <motion.svg
                    animate={{ rotate: openFaq === index ? 180 : 0 }}
                    transition={{ duration: 0.3 }}
                    className="w-6 h-6 text-purple-600 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                  </motion.svg>
                </button>
                <motion.div
                  initial={false}
                  animate={{
                    height: openFaq === index ? 'auto' : 0,
                    opacity: openFaq === index ? 1 : 0
                  }}
                  transition={{ duration: 0.3 }}
                  className="overflow-hidden"
                >
                  <p className="px-6 pb-6 text-gray-700 leading-relaxed">
                    {faq.answer}
                  </p>
                </motion.div>
              </motion.div>
            ))}
          </div>
        </motion.div>

        {/* Back to App */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 1 }}
          className="text-center"
        >
          <button
            onClick={() => navigate(isAuthenticated ? '/app' : '/')}
            className="text-purple-600 hover:text-purple-700 font-bold text-lg hover:underline"
          >
            ‚Üê {isAuthenticated ? 'Back to App' : 'Back to Home'}
          </button>
        </motion.div>
      </div>
    </div>
  );
}
