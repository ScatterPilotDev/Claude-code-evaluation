#!/bin/bash

###############################################################################
# ScatterPilot - Frontend Configuration Script
# Updates the demo frontend to use the real deployed API
###############################################################################

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
OUTPUT_FILE="$PROJECT_ROOT/.deployment-outputs"
DEMO_DIR="$PROJECT_ROOT/demo"

echo -e "${BLUE}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║         ScatterPilot - Frontend Configuration                  ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════════════╝${NC}"
echo ""

# ============================================================================
# Load deployment outputs
# ============================================================================
if [ ! -f "$OUTPUT_FILE" ]; then
    echo -e "${RED}✗ Deployment outputs not found${NC}"
    echo "Please run ./scripts/03-deploy.sh first"
    exit 1
fi

source "$OUTPUT_FILE"

echo -e "${CYAN}Configuration:${NC}"
echo "  API URL: $API_URL"
echo "  Environment: $ENVIRONMENT"
echo ""

# ============================================================================
# Create config.js for frontend
# ============================================================================
echo -e "${BLUE}[Step 1/3] Creating frontend configuration${NC}"
echo ""

CONFIG_FILE="$DEMO_DIR/js/config.js"

cat > "$CONFIG_FILE" <<EOF
/**
 * ScatterPilot Frontend Configuration
 * Auto-generated by configure-frontend.sh
 * Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
 */

const ScatterPilotConfig = {
    // API Configuration
    apiUrl: '$API_URL',
    environment: '$ENVIRONMENT',

    // Feature Flags
    features: {
        demoMode: true,           // Keep demo mode available
        liveMode: true,            // Enable live API mode
        defaultMode: 'demo'        // Start in demo mode by default
    },

    // AWS Configuration
    aws: {
        region: '$AWS_REGION',
        accountId: '$(aws sts get-caller-identity --query Account --output text 2>/dev/null || echo "unknown")'
    },

    // Deployment Info
    deployment: {
        stackName: '$STACK_NAME',
        deployedAt: '$DEPLOYED_AT',
        version: '1.0.0'
    },

    // API Endpoints
    endpoints: {
        conversation: '/conversation',
        createInvoice: '/invoices',
        listInvoices: '/invoices',
        getInvoice: '/invoices/{invoice_id}',
        generatePDF: '/invoices/{invoice_id}/pdf'
    },

    // Settings
    settings: {
        maxRetries: 3,
        timeout: 30000,           // 30 seconds
        rateLimit: {
            maxRequests: 100,
            windowSeconds: 3600
        }
    }
};

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ScatterPilotConfig;
}
EOF

echo -e "${GREEN}✓${NC} Configuration file created: js/config.js"
echo ""

# ============================================================================
# Update app.js to use config
# ============================================================================
echo -e "${BLUE}[Step 2/3] Updating app.js${NC}"
echo ""

# Backup original app.js
if [ ! -f "$DEMO_DIR/js/app.js.backup" ]; then
    cp "$DEMO_DIR/js/app.js" "$DEMO_DIR/js/app.js.backup"
    echo -e "${GREEN}✓${NC} Created backup: js/app.js.backup"
fi

# Update the apiUrl initialization in app.js
if grep -q "apiUrl: ''" "$DEMO_DIR/js/app.js"; then
    sed -i.tmp "s|apiUrl: ''|apiUrl: ScatterPilotConfig?.apiUrl || ''|g" "$DEMO_DIR/js/app.js"
    rm -f "$DEMO_DIR/js/app.js.tmp"
    echo -e "${GREEN}✓${NC} Updated app.js to use configuration"
else
    echo -e "${YELLOW}⚠${NC} app.js already configured or has different format"
fi

echo ""

# ============================================================================
# Update index.html to include config.js
# ============================================================================
echo -e "${BLUE}[Step 3/3] Updating index.html${NC}"
echo ""

# Backup original index.html
if [ ! -f "$DEMO_DIR/index.html.backup" ]; then
    cp "$DEMO_DIR/index.html" "$DEMO_DIR/index.html.backup"
    echo -e "${GREEN}✓${NC} Created backup: index.html.backup"
fi

# Check if config.js is already included
if ! grep -q "config.js" "$DEMO_DIR/index.html"; then
    # Add config.js before mock-api.js
    sed -i.tmp 's|<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>|<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>\n    <script src="js/config.js"></script>|g' "$DEMO_DIR/index.html"
    rm -f "$DEMO_DIR/index.html.tmp"
    echo -e "${GREEN}✓${NC} Added config.js to index.html"
else
    echo -e "${YELLOW}⚠${NC} config.js already included in index.html"
fi

echo ""

# ============================================================================
# Create API client helper
# ============================================================================
echo -e "${BLUE}[Bonus] Creating API client helper${NC}"
echo ""

API_CLIENT_FILE="$DEMO_DIR/js/api-client.js"

cat > "$API_CLIENT_FILE" <<'EOF'
/**
 * ScatterPilot API Client
 * Helper functions for making API calls to the live backend
 */

class ScatterPilotAPIClient {
    constructor(baseUrl, config = {}) {
        this.baseUrl = baseUrl || ScatterPilotConfig?.apiUrl || '';
        this.timeout = config.timeout || 30000;
        this.maxRetries = config.maxRetries || 3;
    }

    /**
     * Make an authenticated API request
     */
    async request(endpoint, options = {}) {
        const url = `${this.baseUrl}${endpoint}`;
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        const config = {
            method: options.method || 'GET',
            headers,
            ...options
        };

        if (options.body) {
            config.body = JSON.stringify(options.body);
        }

        try {
            const response = await this._fetchWithTimeout(url, config, this.timeout);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            }

            return await response.text();
        } catch (error) {
            console.error('API Request Error:', error);
            throw error;
        }
    }

    /**
     * Send a conversation message
     */
    async sendMessage(userId, message, conversationId = null) {
        const body = {
            user_id: userId,
            message: message
        };

        if (conversationId) {
            body.conversation_id = conversationId;
        }

        return await this.request('/conversation', {
            method: 'POST',
            body
        });
    }

    /**
     * Create an invoice
     */
    async createInvoice(userId, invoiceData) {
        return await this.request('/invoices', {
            method: 'POST',
            body: {
                user_id: userId,
                ...invoiceData
            }
        });
    }

    /**
     * List invoices for a user
     */
    async listInvoices(userId, limit = 20, lastKey = null) {
        let endpoint = `/invoices?user_id=${encodeURIComponent(userId)}&limit=${limit}`;

        if (lastKey) {
            endpoint += `&last_key=${encodeURIComponent(JSON.stringify(lastKey))}`;
        }

        return await this.request(endpoint);
    }

    /**
     * Get a specific invoice
     */
    async getInvoice(invoiceId) {
        return await this.request(`/invoices/${invoiceId}`);
    }

    /**
     * Generate PDF for an invoice
     */
    async generatePDF(invoiceId) {
        return await this.request(`/invoices/${invoiceId}/pdf`, {
            method: 'POST'
        });
    }

    /**
     * Fetch with timeout
     */
    _fetchWithTimeout(url, options, timeout) {
        return Promise.race([
            fetch(url, options),
            new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Request timeout')), timeout)
            )
        ]);
    }
}

// Create global instance if config is available
if (typeof ScatterPilotConfig !== 'undefined' && ScatterPilotConfig.apiUrl) {
    window.scatterPilotAPI = new ScatterPilotAPIClient(
        ScatterPilotConfig.apiUrl,
        ScatterPilotConfig.settings
    );
}
EOF

echo -e "${GREEN}✓${NC} Created API client: js/api-client.js"
echo ""

# ============================================================================
# Update live API implementation in app.js
# ============================================================================
echo -e "${BLUE}[Bonus] Updating callLiveAPI function${NC}"
echo ""

# Check if we need to update callLiveAPI
if grep -q "async function callLiveAPI(message)" "$DEMO_DIR/js/app.js"; then
    # Create a better implementation
    cat > /tmp/callLiveAPI.js <<'EOF'
async function callLiveAPI(message) {
    if (!window.scatterPilotAPI) {
        window.scatterPilotAPI = new ScatterPilotAPIClient(
            appState.apiUrl,
            ScatterPilotConfig?.settings || {}
        );
    }

    try {
        const response = await window.scatterPilotAPI.sendMessage(
            appState.userId || 'demo-user-' + Date.now(),
            message,
            appState.conversationId
        );

        return {
            conversationId: response.conversation_id,
            message: response.message,
            invoiceReady: response.invoice_ready || false,
            invoiceData: response.invoice_data || null
        };
    } catch (error) {
        console.error('Live API Error:', error);
        throw new Error(`API Error: ${error.message}`);
    }
}
EOF

    echo -e "${YELLOW}⚠${NC} Manual update recommended for callLiveAPI function"
    echo "   See /tmp/callLiveAPI.js for improved implementation"
fi

echo ""

# ============================================================================
# Summary
# ============================================================================
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Frontend Configuration Complete!${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""

echo -e "${BLUE}Created files:${NC}"
echo "  ✓ demo/js/config.js         - Frontend configuration"
echo "  ✓ demo/js/api-client.js     - API client helper"
echo "  ✓ demo/js/app.js.backup     - Backup of original app.js"
echo "  ✓ demo/index.html.backup    - Backup of original index.html"
echo ""

echo -e "${BLUE}API Configuration:${NC}"
echo "  API URL:     $API_URL"
echo "  Environment: $ENVIRONMENT"
echo "  Region:      $AWS_REGION"
echo ""

echo -e "${BLUE}Testing the Frontend:${NC}"
echo ""
echo "  1. Start local server:"
echo "     cd demo && python3 -m http.server 8000"
echo ""
echo "  2. Open in browser:"
echo "     http://localhost:8000"
echo ""
echo "  3. Toggle to 'Live API' mode and test"
echo ""

echo -e "${BLUE}Deploying Frontend to Production:${NC}"
echo ""
echo "  Option A: S3 + CloudFront (Recommended)"
echo "    - Create S3 bucket for static hosting"
echo "    - Upload demo/ contents to S3"
echo "    - Set up CloudFront distribution"
echo ""
echo "  Option B: GitHub Pages"
echo "    - Push demo/ folder to gh-pages branch"
echo "    - Enable GitHub Pages in repository settings"
echo ""
echo "  Option C: Netlify/Vercel"
echo "    - Connect repository"
echo "    - Set publish directory to 'demo/'"
echo "    - Deploy"
echo ""

echo -e "${GREEN}Configuration saved!${NC}"
echo ""
